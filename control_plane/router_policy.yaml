# Router Policy Configuration
version: "1.0"
updated_at: "2024-01-01T00:00:00Z"

# Default routing configuration
defaults:
  primary_model: "o4-mini"  # Can be overridden by feature flag
  timeout_seconds: 30
  retry_attempts: 3
  fallback_enabled: true

# Domain-specific routing policies
domain_policies:
  robotics:
    description: "High-stakes physical robot control"
    primary_model: "rt-2"
    secondary_models: ["o4", "gemini-2.5-pro"]
    requirements:
      hitl_gate: true
      safety_check: true
      capability_required: ["robot.actuate", "robot.plan"]
    constraints:
      max_latency_ms: 100
      min_confidence_score: 0.95
    guardrails:
      - type: "safety_boundary"
        params:
          max_velocity: 1.0
          workspace_limits: true
      - type: "collision_detection"
        enabled: true
    error_budget:
      threshold_per_hour: 5
      action: "fallback"  # or "block"

  simulation:
    description: "Compute-intensive simulation workloads"
    primary_model: "gemini-2.5-pro"
    secondary_models: ["gemini-2-flash", "o4-mini"]
    requirements:
      hitl_gate: false
      capability_required: ["sim.run", "sim.modify"]
    constraints:
      max_context_tokens: 128000
      max_compute_time_seconds: 300
    guardrails:
      - type: "resource_limits"
        params:
          max_memory_gb: 32
          max_cpu_cores: 16
    error_budget:
      threshold_per_hour: 20
      action: "alert"

  appdev:
    description: "Application development assistance"
    tiers:
      basic:
        primary_model: "gpt-4"
        secondary_models: ["gpt-3.5-turbo"]
        rate_limit_per_hour: 100
        max_tokens: 4096
      standard:
        primary_model: "o4-mini"
        secondary_models: ["gpt-4"]
        rate_limit_per_hour: 500
        max_tokens: 8192
      premium:
        primary_model: "o4"
        secondary_models: ["o4-mini", "claude-3-opus"]
        rate_limit_per_hour: 1000
        max_tokens: 32768
    requirements:
      capability_required: ["llm.generate", "repo.read"]
    guardrails:
      - type: "code_safety"
        params:
          scan_vulnerabilities: true
          block_malicious: true

  research:
    description: "Research and analysis tasks"
    primary_model: "o4-mini"
    secondary_models: ["claude-3", "gpt-4"]
    requirements:
      capability_required: ["llm.generate", "data.read"]
    constraints:
      max_context_tokens: 100000
      allow_web_search: true
    guardrails:
      - type: "pii_filter"
        enabled: true
      - type: "citation_check"
        enabled: true

# Capability-based routing rules
capability_routing:
  repo.commit:
    preferred_models: ["o4", "gpt-4"]
    require_review: true
    
  robot.actuate:
    preferred_models: ["rt-2"]
    require_hitl: true
    
  llm.generate:
    preferred_models: ["o4-mini", "gpt-4", "claude-3"]
    load_balance: true
    
  data.read:
    preferred_models: ["gpt-4", "claude-3"]
    cache_enabled: true

# Fallback policies
fallback_policies:
  model_unavailable:
    strategy: "sequential"  # or "random", "least_loaded"
    max_attempts: 3
    backoff_multiplier: 2.0
    
  rate_limit_exceeded:
    strategy: "exponential_backoff"
    initial_delay_ms: 1000
    max_delay_ms: 60000
    
  budget_exceeded:
    strategy: "block"
    notification_channels: ["email", "slack"]
    
  hitl_timeout:
    strategy: "escalate"
    timeout_seconds: 300
    escalation_path: ["operator", "supervisor", "auto_deny"]

# Guardrails configuration
guardrails:
  global:
    - type: "content_filter"
      params:
        block_pii: true
        block_harmful: true
        
    - type: "rate_limiter"
      params:
        global_rpm: 10000
        per_tenant_rpm: 1000
        
    - type: "budget_monitor"
      params:
        daily_limit_usd: 10000
        alert_threshold_pct: 80
        
  robotics_specific:
    - type: "safety_monitor"
      params:
        emergency_stop: true
        human_override: true
        
    - type: "trajectory_validator"
      params:
        check_collisions: true
        verify_limits: true

# Error budgets
error_budgets:
  global:
    slo_target: 99.9
    error_budget_minutes_per_month: 43.2
    
  per_domain:
    robotics:
      slo_target: 99.99
      error_budget_minutes_per_month: 4.32
      
    simulation:
      slo_target: 99.5
      error_budget_minutes_per_month: 216
      
    appdev:
      slo_target: 99.9
      error_budget_minutes_per_month: 43.2

# Load balancing configuration
load_balancing:
  strategy: "weighted_round_robin"
  health_check_interval_seconds: 30
  weights:
    o4: 10
    o4-mini: 30
    gpt-4: 20
    deepseek-v3: 15
    gemini-2.5-pro: 15
    rt-2: 10

# Monitoring and alerting
monitoring:
  metrics_enabled: true
  trace_sampling_rate: 0.1
  log_level: "info"
  
  alerts:
    - name: "high_error_rate"
      condition: "error_rate > 0.05"
      window_minutes: 5
      channels: ["pagerduty", "slack"]
      
    - name: "budget_warning"
      condition: "daily_spend > daily_limit * 0.8"
      channels: ["email", "slack"]
      
    - name: "hitl_queue_backup"
      condition: "hitl_queue_size > 100"
      channels: ["slack"]

# A/B testing configuration
ab_tests:
  - name: "new_router_algorithm"
    enabled: false
    percentage: 10
    variants:
      control: "current_algorithm"
      treatment: "ml_based_routing"
    metrics: ["latency", "success_rate", "cost"]