# observability/otel-collector.yaml
# EXTENDED: Added cost_usd processor and SIEM exporter stub
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:
    timeout: 10s
    send_batch_size: 1024
    send_batch_max_size: 2048

  # Cost attribution processor - adds cost_usd to all spans
  attributes/cost:
    actions:
      - key: cost_usd
        value: 0.0001  # Base cost per span (placeholder)
        action: upsert
      # Adjust cost based on span attributes
      - key: cost_usd
        value: 0.001
        action: update
        from_attribute: operation
        converted_type: double
        # Higher cost for tool invocations
        filter:
          match_type: regexp
          span_names: ["tool.*", "llm.*", "model.*"]
      # Even higher cost for robot operations
      - key: cost_usd
        value: 0.01
        action: update
        filter:
          match_type: regexp
          span_names: ["robot.*", "actuate.*"]

  # Resource processor for standard labels
  resource:
    attributes:
      - key: service.namespace
        value: production
        action: insert
      - key: deployment.environment
        from_attribute: DEPLOYMENT_ENV
        action: insert

exporters:
  # Primary telemetry backend
  otlp/primary:
    endpoint: "telemetry-backend:4317"
    tls:
      insecure: false
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

  # SIEM sink stub for critical security events
  otlp/siem:
    endpoint: "siem-stub.internal:4318"  # Stub endpoint
    headers:
      X-SIEM-API-Key: "${env:SIEM_API_KEY}"
      X-Event-Source: "otel-collector"
    sending_queue:
      enabled: true
      queue_size: 1000
    # Only send high-severity events
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 10s

  # Prometheus for metrics/alerts
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: otel
    const_labels:
      environment: production

  # Debug logging (disabled in prod)
  logging:
    loglevel: info
    sampling_initial: 10
    sampling_thereafter: 100

extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  pprof:
    endpoint: 0.0.0.0:1777

service:
  extensions: [health_check, pprof]
  
  pipelines:
    # Main trace pipeline with cost attribution
    traces:
      receivers: [otlp]
      processors: [batch, attributes/cost, resource]
      exporters: [otlp/primary]
    
    # Metrics pipeline
    metrics:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [prometheus, otlp/primary]
    
    # Main logs pipeline
    logs:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [otlp/primary]
    
    # Security events to SIEM
    logs/security:
      receivers: [otlp]
      processors: [batch]
      exporters: [otlp/siem]

telemetry:
  logs:
    level: info
    encoding: json
  metrics:
    level: detailed
    address: 0.0.0.0:8888